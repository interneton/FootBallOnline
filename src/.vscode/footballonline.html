<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Football Online</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <header>
        <h1>Football Online</h1>
        <div id="logoutBtnBox">
            <button id="logout-btn" style="display: none;">로그아웃</button>
        </div>
    </header>

    <main>
        <!-- 로그인 섹션 -->
        <section id="auth-section">
            <h2>로그인</h2>
            <div id="login-form">
                <form id="loginForm">
                    <label for="login-account">이메일:</label>
                    <input type="email" id="login-account" name="account" required>
                    <label for="login-password">비밀번호:</label>
                    <input type="password" id="login-password" name="password" required>
                    <button type="submit" class="btn">로그인</button>
                </form>
                <p id="login-message"></p>
            </div>
        </section>

        <!-- 회원가입 섹션 -->
        <section id="signup-section">
            <h2>회원가입</h2>
            <div id="signup-form">
                <h3>회원가입</h3>
                <form id="signupForm">
                    <label for="signup-account">이메일:</label>
                    <input type="email" id="signup-account" name="account" required> <!-- 이메일 입력 필드 -->
                    <label for="signup-password">비밀번호:</label>
                    <input type="password" id="signup-password" name="password" required> <!-- 비밀번호 입력 필드 -->
                    <br>
                    <label for="signup-name">이름:</label>
                    <input type="text" id="signup-name" name="name" required> <!-- 이름 입력 필드 -->
                    <label for="signup-teamName">팀 이름:</label>
                    <input type="text" id="signup-teamName" name="teamName" required> <!-- 팀 이름 입력 필드 -->
                    <button type="submit" class="btn">회원가입</button> <!-- 회원가입 버튼 -->
                </form>
                <p id="signup-message"></p> <!-- 회원가입 메시지 표시 -->
            </div>
        </section>

        <!-- 캐시 상점 섹션 -->
        <section id="cashShop-section" style="display: none;">
            <h2>캐시 상점</h2>
            <button id="buy-cash-100-btn" class="btn">100 캐시 구매하기</button>
            <button id="buy-cash-500-btn" class="btn">500 캐시 구매하기</button>
            <button id="buy-cash-1000-btn" class="btn">1000 캐시 구매하기</button>
            <p id="cash-amount">보유 캐시: </p>
        </section>

        <!-- 가챠 섹션 -->
        <section id="shop-section" style="display: none;">
            <h2>가챠 상점</h2>
            <p>사용 가능한 팩을 선택하여 선수를 뽑으세요.</p>
            <select id="pack-select"></select> <!-- 팩 선택 -->
            <button id="draw-player-1-btn" class="btn">1회 뽑기 (100 캐시)</button>
            <button id="draw-player-5-btn" class="btn">5회 뽑기 (500 캐시)</button>
            <button id="draw-player-10-btn" class="btn">10회 뽑기 (1000 캐시)</button>
            <p id="draw-result">선수 뽑기 결과가 여기에 표시됩니다.</p>
            <p id="cash-amount">보유 캐시: </p>
        </section>

        <!-- 선수 관리 섹션 -->
        <section id="player-section" style="display: none;">
            <h2>나만의 팀 구성</h2>
            <div>
                <h3>장착된 선수 목록 (최대 3명)</h3>
                <ul id="equipped-players-list"></ul>
            </div>
            <div>
                <h3>모든 선수 목록</h3>
                <ul id="all-players-list"></ul>
                <button id="equip-player-btn" class="btn">선수 장착하기</button>
                <button id="unequip-player-btn" class="btn">선수 해제하기</button>
            </div>
        </section>

        <!-- 경기 섹션 -->
        <section id="game-section" style="display: none;">
            <h2>경기 시작</h2>
            <button id="start-game-btn" class="btn">경기 시작하기</button>
            <div id="game-result">
                <h3>경기 결과</h3>
                <p id="game-result-text">결과가 여기에 표시됩니다.</p>
            </div>
        </section>
    </main>

    <footer>
        <p>&copy; 2024 Football Online</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const baseUrl = 'http://localhost:3000'; // 백엔드 API 주소

            // 로그인 처리
            document.getElementById('loginForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const account = document.getElementById('login-account').value;
                const password = document.getElementById('login-password').value;

                try {
                    const response = await fetch(`${baseUrl}/users/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ account, password }),
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`로그인 실패: ${errorText}`);
                    }

                    const { accessToken } = await response.json();
                    localStorage.setItem('accessToken', accessToken);
                    document.getElementById('login-message').textContent = '로그인 성공!';
                    showGameSections();
                    document.getElementById('cashShop-section').style.display = 'block';
                    document.getElementById('signup-section').style.display = 'none';
                } catch (error) {
                    document.getElementById('login-message').textContent = `오류: ${error.message}`;
                }
            });

            // 로그아웃 처리
            document.getElementById('logout-btn').addEventListener('click', () => {
                localStorage.removeItem('accessToken');
                document.getElementById('logout-btn').style.display = 'none';
                document.getElementById('game-section').style.display = 'none';
                document.getElementById('player-section').style.display = 'none';
                document.getElementById('shop-section').style.display = 'none';
                document.getElementById('auth-section').style.display = 'block';
                document.getElementById('login-message').textContent = '';
                document.getElementById('signup-section').style.display = 'block';
                document.getElementById('cashShop-section').style.display = 'none';
            });

            // 캐시 구매 처리
            document.getElementById('buy-cash-100-btn').addEventListener('click', () => purchaseCash(100));
            document.getElementById('buy-cash-500-btn').addEventListener('click', () => purchaseCash(500));
            document.getElementById('buy-cash-1000-btn').addEventListener('click', () => purchaseCash(1000));

            async function purchaseCash(amount) {
                const token = localStorage.getItem('accessToken');
                if (!token) return;

                try {
                    const response = await fetch(`${baseUrl}/shop/purchase`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ amount })
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`캐시 구매 실패: ${errorText}`);
                    }

                    const { cash } = await response.json();
                    document.getElementById('cash-amount').textContent = `보유 캐시: ${cash}`;
                    alert(`${amount} 캐시를 성공적으로 구매했습니다.`);
                } catch (error) {
                    alert(`오류: ${error.message}`);
                }
            }

            // 팩 정보 가져오기 및 팩 선택
            async function fetchPacks() {
                const token = localStorage.getItem('accessToken');
                if (!token) return;

                try {
                    const response = await fetch(`${baseUrl}/shop/getPacks`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    const packs = await response.json();
                    const packSelect = document.getElementById('pack-select');
                    packs.forEach(pack => {
                        const option = document.createElement('option');
                        option.value = pack.id;
                        option.text = `${pack.name} (가격: ${pack.price} 캐시)`;
                        packSelect.appendChild(option);
                    });
                } catch (error) {
                    alert(`팩 정보를 불러오는 데 실패했습니다: ${error.message}`);
                }
            }

            // 선수 뽑기 처리
            document.getElementById('draw-player-1-btn').addEventListener('click', () => drawPlayer(1));
            document.getElementById('draw-player-5-btn').addEventListener('click', () => drawPlayer(5));
            document.getElementById('draw-player-10-btn').addEventListener('click', () => drawPlayer(10));

            async function drawPlayer(count) {
                const token = localStorage.getItem('accessToken');
                const packId = document.getElementById('pack-select').value;
                if (!token || !packId) return;

                try {
                    const response = await fetch(`${baseUrl}/shop/draw`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ packId, count })
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`선수 뽑기 실패: ${errorText}`);
                    }

                    const { selectedPlayers, cash } = await response.json();
                    document.getElementById('draw-result').textContent = `뽑힌 선수들: ${selectedPlayers.map(p => p.name).join(', ')}`;
                    document.getElementById('cash-amount').textContent = `보유 캐시: ${cash}`;
                } catch (error) {
                    alert(`오류: ${error.message}`);
                }
            }

            // 장착된 선수 목록 및 전체 선수 목록 불러오기
            async function fetchPlayers() {
                const token = localStorage.getItem('accessToken');
                if (!token) return;

                try {
                    const [equippedPlayers, allPlayers] = await Promise.all([
                        fetch(`${baseUrl}/players/equipped`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        }).then(res => res.json()),
                        fetch(`${baseUrl}/players/all`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        }).then(res => res.json())
                    ]);

                    const equippedPlayersList = document.getElementById('equipped-players-list');
                    equippedPlayersList.innerHTML = '';
                    equippedPlayers.forEach(player => {
                        const li = document.createElement('li');
                        li.textContent = `${player.name} (속력: ${player.speed}, 골 결정력: ${player.goalDecision})`;
                        equippedPlayersList.appendChild(li);
                    });

                    const allPlayersList = document.getElementById('all-players-list');
                    allPlayersList.innerHTML = '';
                    allPlayers.forEach(player => {
                        const li = document.createElement('li');
                        li.textContent = `${player.name} (속력: ${player.speed}, 골 결정력: ${player.goalDecision})`;
                        li.dataset.playerId = player.soccerPlayerId;
                        allPlayersList.appendChild(li);
                    });
                } catch (error) {
                    alert(`선수 정보를 불러오는 데 실패했습니다: ${error.message}`);
                }
            }

            // 선수 장착 및 해제 기능
            document.getElementById('equip-player-btn').addEventListener('click', async () => {
                const selectedPlayerId = document.querySelector('#all-players-list li.selected')?.dataset?.playerId;
                if (!selectedPlayerId) return alert('장착할 선수를 선택하세요.');

                const token = localStorage.getItem('accessToken');
                try {
                    const response = await fetch(`${baseUrl}/players/equip`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ soccerPlayerId: selectedPlayerId })
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`선수 장착 실패: ${errorText}`);
                    }

                    await fetchPlayers(); // 선수 목록 다시 불러오기
                } catch (error) {
                    alert(`선수 장착 실패: ${error.message}`);
                }
            });

            document.getElementById('unequip-player-btn').addEventListener('click', async () => {
                const selectedPlayerId = document.querySelector('#equipped-players-list li.selected')?.dataset?.playerId;
                if (!selectedPlayerId) return alert('해제할 선수를 선택하세요.');

                const token = localStorage.getItem('accessToken');
                try {
                    const response = await fetch(`${baseUrl}/players/unequip`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ soccerPlayerId: selectedPlayerId })
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`선수 장착 해제 실패: ${errorText}`);
                    }

                    await fetchPlayers(); // 선수 목록 다시 불러오기
                } catch (error) {
                    alert(`선수 장착 해제 실패: ${error.message}`);
                }
            });

            // 경기 시작 버튼
            document.getElementById('start-game-btn').addEventListener('click', async () => {
                const token = localStorage.getItem('accessToken');
                if (!token) return;

                try {
                    const response = await fetch(`${baseUrl}/game/play`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    const { result } = await response.json();
                    document.getElementById('game-result-text').textContent = `경기 결과: ${result}`;
                } catch (error) {
                    alert(`경기 시작 실패: ${error.message}`);
                }
            });

            // 게임 섹션 표시
            function showGameSections() {
                document.getElementById('auth-section').style.display = 'none';
                document.getElementById('cashShop-section').style.display = 'block';
                document.getElementById('shop-section').style.display = 'block';
                document.getElementById('player-section').style.display = 'block';
                document.getElementById('game-section').style.display = 'block';
                document.getElementById('logout-btn').style.display = 'block';

                // 팩 목록 및 선수 목록 불러오기
                fetchPacks();
                fetchPlayers();
            }
        });
    </script>
</body>

</html>